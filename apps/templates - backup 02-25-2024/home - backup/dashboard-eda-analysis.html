{% extends "layouts/base.html" %}

{% block title %} EDA - User Clicks {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
<!-- Breadcrumb starts -->
<!-- Tabs start -->
<div class="container mt-0">
   <!-- Nav tabs -->
   <ul class="nav nav-tabs" id="progressTabs" role="tablist">
      <li class="nav-item">
          <a class="nav-link active" id="tab1-tab" data-bs-toggle="tab" href="#tab1" role="tab" aria-controls="tab1" aria-selected="false">
              <svg class="icon icon-xxs me-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
              Data
          </a>
      </li>
      <li class="nav-item">
          <a class="nav-link" id="tab2-tab" data-bs-toggle="tab" href="#tab2" role="tab" aria-controls="tab2" aria-selected="true">
              <svg class="icon icon-xxs me-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
              Reports
          </a>
      </li>
      <!-- Add more tabs as needed -->
   </ul>

   <!-- Tab content -->
   <div class="tab-content mt-2">
      <div class="tab-pane fade show active" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">
         <!-- Content for Tab 1 -->
         <div class="master-div">
            <div class="row mb-4 ..."></div>
            <div class="table-settings mb-3">
               <div class="row justify-content-between align-items-center">
                  <div class="col-9 col-lg-9 d-md-flex">
                     <div class="input-group me-2 me-lg-4 fmxw-700">
                        <span>
                           <svg class="icon icon-xs" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                              <path fill-rule="evenodd" d="M3 2h14a1 1 0 010 2H3a1 1 0 010-2zm0 6h14a1 1 0 010 2H3a1 1 0 010-2zm0 6h14a1 1 0 010 2H3a1 1 0 010-2z" clip-rule="evenodd"></path>
                           </svg>
                        </span>
                        &nbsp;&nbsp;<span class="text-decoration-underline">Search user clicks</span>
                     </div>
                  </div>
                  <div class="col-2 col-lg-3 d-flex justify-content-start">
                     <button type="button" class="btn btn-secondary execute-btn" id="load-UserClicks" data-action="load">Execute</button>
                  </div>
               </div>
               <div class="py-4">
                  <!-- Add the spinner here -->
                  <div class="loading-spinner">
                     <i class="fas fa-spinner fa-spin"></i> Loading...
                  </div>
                  <div class="row mb-4 ..."></div>
                  <div class="card card-body border-0 table-wrapper table-responsive">
                        <table id="data" class="table table-hover" cellspacing="0" width="100%">
                        </table>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="tab-pane fade" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
         <!-- Content for Tab 2 -->
         <div class="master-div">
            <div class="row mb-4 ..."></div>
            <!-- Add your Tab content here -->
            <!-- Step 2-->
            <div class="table-settings mb-3">
               <div class="row justify-content-between">
                  <div class="col-6 col-lg-6 d-md-flex">
                     <div class="input-group me-2 me-lg-4 fmxw-700 col-2">
                        <button class="btn btn-sm btn-secondary me-2" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <svg class="icon icon-xs" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                            Choose an Analysis
                        </button>
                        <select id="options" name="options" class="form-select fmxw-200 me-2 col-2" aria-label="Message select example">
                            <option value="All" {% if options=='All' %} selected="selected"{% endif %}>All</option>
                            <option value="Report1" {% if options=='Report 1' %} selected="selected"{% endif %}>Report 1</option>
                            <option value="Report2" {% if options=='Report 2' %} selected="selected"{% endif %}>Report 2</option>
                            <option value="Report3" {% if options=='Report 3' %} selected="selected"{% endif %}>Report 3</option>
                        </select>

                     <button type="button" class="btn btn-secondary execute-btn" id="load-Plot1" data-action="load">Execute</button>
                  </div>
               </div>
             <div class="py-4">
                  <!-- Add the spinner here -->
                  <div class="loading-spinner">
                     <i class="fas fa-spinner fa-spin"></i> Loading...
                  </div>
                  <div class="row mb-4 ..."></div>
                    <div class="card-body p-3">
                        <div id="plot1">
                            {% if plot1 %}
                                {{plot1|safe}}
                            {% else %}
                                <p>No plot called plot1 available.</p>
                            {% endif %}
                        </div>
                    </div>
               </div>
            </div>
         </div>

        </div>
      </div>
      <!-- Add more tab content divs as needed -->
   </div>
<!-- Tabs End -->
<!-- Tabs End -->
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script>
// Tab : 1 [Function to load user clicks and present it as datatable]
// Step: 1 [Function to load the User Sessions]
function loadUserClicks(action) {
    // Show loading spinner
    $('.loading-spinner').show();
    // Clear previous results
    clearResults();
    console.log(action)
    // Get the value of the 'options' select element
    var optionsValue = $('#options').val();
    console.log(optionsValue)
    // AJAX request to your Flask route
    $.ajax({
        type: 'POST',
        url: '/load_UserClick',
        data: {
            action: action,
            options: optionsValue
        },
        success: function (data) {
            // Handle the success case
            console.log("Success");
            // Initialize DataTable only when there is data
            if (data && data.data && data.data.length > 0) {
                console.log("There are Sessions..");
                // Initialize DataTable only when there is data
                var dataTable = $('#data').DataTable({
                    data: data.data,  // Assuming 'data' is the property name containing the data array
                    columns: [
                          {data: 'date', orderable: true, searchable: true, title: "Date", "render": function(data, type)
                                {return type === 'sort' ? data : moment(data).format('L');}},
                          {data: 'term', orderable: true, searchable: true, title: "Search Term"},
                          {data: 'sku', orderable: true, searchable: true, title: "Airgas Part#"},
                          {data: 'position', orderable: true, searchable: true, title: "Page:Position"},
                          {data: 'rank', orderable: true, searchable: true, title: "Rank"},
                          {data: 'clicks', orderable: true, searchable: true, title: "Total Clicks"},
                    ],
                    destroy: true,  // Destroy the existing DataTable instance before creating a new one
                    processing: true,  // Show a processing indicator
                    language: {
                        processing: '<div class="spinner-border text-primary" role="status"></div>',
                    },
                    bSortable: true,
                    lengthMenu: [[50, 100, 200, -1], [50, 100, 200, "All"]],
                    dom: "lBfrtip", // Include length menu (l) along with Bfrtip buttons
                    buttons: [
                        {
                            extend: 'copy',
                            text: 'Copy',
                            filename: 'UserClick_report',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4, 5]
                            }
                        },
                        {
                            extend: 'csv',
                            title: "User Clicks report",
                            messageTop: 'User Clicks Report',
                            text: 'CSV',
                            filename: 'UserClick_report',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4, 5]
                            }
                        },
                        {
                            extend: 'excel',
                            title: "User Clicks report",
                            messageTop: 'User Clicks Report',
                            text: 'Excel',
                            filename: 'UserClick_report',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4, 5]
                            }
                        },
                        {
                            extend: 'pdf',
                            title: "User Clicks report",
                            messageTop: 'User Clicks Report',
                            text: 'PDF',
                            filename: 'UserClick_report',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4, 5]
                            }
                        },
                        {
                            extend: 'print',
                            text: 'Print',
                            filename: 'UserClick_report',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4, 5]
                            }
                        }
                    ],
                    oLanguage: {
                      sSearch: 'Filter Data '
                    },
                    order: [[1, 'asc']],
                    sPaginationType: 'full_numbers',
                    initComplete: function () {
                        // Hide loading spinner on initialization complete
                        $('.loading-spinner').hide();
                    },
                    error: function (jqXHR) {
                        // Handle the error case
                        alert('An error occurred during DataTable initialization.');
                        console.log('Error:', jqXHR);
                        // Hide loading spinner
                        $('.loading-spinner').hide();
                    }
                });

                // Optionally, you can bind an event handler to the DataTable for further customization
                dataTable.on('draw', function () {
                    console.log('User Clicks Table redrawing...');
                });

                // Optionally, you can apply additional logic based on your requirements
                // displayResults(data);
            } else {
                // If there is no data, you can handle it accordingly
                console.log('No sessions data to display.');
            }
            // Hide loading spinner (in case the DataTable initComplete is not triggered)
            $('.loading-spinner').hide();
        },
        error: function (jqXHR) {
            // Handle the error case
            alert('An error occurred during the search.');
            console.log('Error:', jqXHR);
            // Hide loading spinner
            $('.loading-spinner').hide();
        }
    });
}

// Event handler for the execute button
$('#load-UserClicks').click(function () {
    // Call the function to execute the search
    loadUserClicks('load');
    // Expand the result div after each search execution
    $("#data").show();
});

// Function to clear previous results
function clearResults() {
    $('#data').empty();
}

// Tab 2: [Report Tab]
function plot1(action) {
    // Show loading spinner
    $('.loading-spinner').show();
    // Clear previous results
    clearResults();
    console.log(action)
    // AJAX request to your Flask route
    $.ajax({
        type: 'POST',
        url: '/plot1',
        data: {
            action: action
        },
        success: function (data) {
            // Handle the success case
            console.log("Success");
            var plot = data.response;  // Use the correct property name
            console.log(plot)
            if (plot) {
                console.log('Received encoded image for FP:', plot);
                $('#plot1').html(plot);
            } else {
                console.log('No encoded image received for plot.');
                $('#plot1').html('<p>No Pairwise Transformation Plot available for FP.</p>');
            }
            // Hide loading spinner (in case the DataTable initComplete is not triggered)
            $('.loading-spinner').hide();
        },
        error: function (jqXHR, textStatus, errorThrown) {
            // Handle the error case
            alert('An error occurred during the search.');
            console.log('Error:', textStatus, errorThrown);
            // Hide loading spinner
            $('.loading-spinner').hide();
        }
    });
}

// Event handler for the execute button
$('#load-Plot1').click(function () {
    // Call the function to execute the search
    console.log("inside click load-Plot1")
    plot1('load');
    // Expand the result div after each search execution
    $("#plot1").show();
});

// Function to clear previous results
function clearResults() {
    $('#plot1').empty();
}
</script>
{% endblock javascripts %}
